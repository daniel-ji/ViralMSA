<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="./assets/index.css">
</head>
<body>
    <script src="coi-serviceworker.min.js"></script>
    <script type="module" async>
        const viralmsaworker = new Worker('./viralmsaworker.js');
        const minimap2worker = new Worker('./minimap2worker.js');

        // shared array buffer for waiting for minimap2 to finish and transmitting file data (50MB)
        const sharedArrayBuffer = new SharedArrayBuffer(52428800);
        const sharedArray = new Int32Array(sharedArrayBuffer);  
        viralmsaworker.postMessage({'arraybuffer': sharedArray})
        minimap2worker.postMessage({'arraybuffer': sharedArray})
        
        // Pyodide WebWorker (ViralMSA.py) handling
        viralmsaworker.onmessage = (event) => {
            // error handling
            if (event.data.error) {
                alert(event.data.error);

            // done loading web page
            } else if (event.data.init) {
                document.getElementById("content").classList.remove("d-none")
                document.getElementById("loading").classList.add("d-none")

            // download results
            } else if (event.data.download) {
                for (const download of event.data.download) {
                    // first element of array is filename, second element is content
                    downloadFile(download[0], download[1])
                }

            // updating console
            } else if (event.data.pyodideConsole) {
                document.getElementById("pyodide-console").innerHTML += event.data.pyodideConsole;
            
            // on ViralMSA finish
            } else if (event.data.outputPreview) {
                document.getElementById("output-aln").innerText = event.data.outputPreview;
                document.getElementById("seq-aln-map").innerText = event.data.samPreview;
                document.getElementById("duration").innerText = "Total runtime: " + event.data.duration + " seconds";
            
            // Pyodide call to run minimap2 
            } else if (event.data.runminimap2) {
                if (event.data.runminimap2 === 'alignment') {
                    minimap2worker.postMessage({'runminimap2': 'alignment', 'command': event.data.command, 'refSeq': event.data.refSeq});
                } else if (event.data.runminimap2 === 'buildIndex') {
                    minimap2worker.postMessage({'runminimap2': 'buildIndex', 'command': event.data.command, 'inputSeq': event.data.inputSeq});
                }
            }

            // Minimap2 WebWorker handling
            minimap2worker.onmessage = (event) => {
                // Minimap2 done running
                if (event.data.minimap2done) {
                    const fileData = event.data.minimap2done === 'alignment' ? event.data.sam : event.data.mmi;

                    // adjust array size to be divisible by 4
                    const adjustedArray = new Uint8Array(Math.ceil(fileData.length / 4) * 4);
                    adjustedArray.set(fileData);
                    // update shared array buffer
                    sharedArray.set(new Uint32Array(adjustedArray.buffer), 0)

                    // notify ViralMSA WebWorker that Minimap2 is done
                    Atomics.notify(sharedArray, 0);
                }
            }
            
        }

        document.getElementById("runViralMSA").addEventListener("click", () => {
            // validation
            const inputSequences = document.getElementById("input-sequences").files[0];
            if (!inputSequences) {
                alert("Please enter an input sequence file.");
                return;
            }

            const referenceSequence = document.getElementById("ref-sequence").files[0];
            if (!referenceSequence) {
                alert("Please enter a reference sequence file.");
                return;
            }

            // validation passed
            // clear console and runtime record
            document.getElementById("pyodide-console").innerHTML = "";
            document.getElementById("duration").innerText = "Running...";

            let inputSeq;
            let refSeq;

            // sending file data to webworker
            const inputSeqReader = new FileReader();
            inputSeqReader.readAsText(inputSequences, "UTF-8");
            inputSeqReader.onload = (e) => {
                inputSeq = e.target.result;
            }

            const refSeqReader = new FileReader();
            refSeqReader.readAsText(referenceSequence, "UTF-8");
            refSeqReader.onload = (e) => {
                refSeq = e.target.result;
            }

            // wait until file data is read and then run ViralMSA
            const interval = setInterval(() => {
                if (inputSeq && refSeq) {
                    clearInterval(interval);
                    viralmsaworker.postMessage({'run': 'viralmsa', 'inputSeq': inputSeq, 'refSeq': refSeq});
                }
            }, 100);
        });

        // get results for downloading
        document.getElementById("downloadResults").addEventListener("click", () => {
            viralmsaworker.postMessage({'getResults': 'all'});
        });

        // from: https://stackoverflow.com/questions/2897619/using-html5-javascript-to-generate-and-save-a-file
        // helper function to download files
        const downloadFile = (filename, text) => {
            var pom = document.createElement('a');
            pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            pom.setAttribute('download', filename);

            if (document.createEvent) {
                var event = document.createEvent('MouseEvents');
                event.initEvent('click', true, true);
                pom.dispatchEvent(event);
            }
            else {
                pom.click();
            }
        }

    </script>
    <h1 class="my-5 text-center">ViralMSA Online Tool</h1>
    <div id="loading">
        <h4 class="text-center" >Loading ... </h4>
    </div>
    <div id="content" class="d-none">
        <div class="input">
            <div class="mb-3">
                <label for="input-sequences" class="form-label">Input Sequences (FASTA Format)</label>
                <input class="form-control" type="file" id="input-sequences">
            </div>
        
            <div class="mb-3">
                <label for="ref-sequence" class="form-label">Reference Sequence</label>
                <input class="form-control" type="file" id="ref-sequence">
            </div>

            <button type="button" class="mt-3 btn btn-primary" id="runViralMSA">Run ViralMSA</button>
            <button type="button" class="mt-3 btn btn-primary" id="downloadResults">Download Results</button>
            <p class="my-3" id="duration"></p>
        </div>
        <div class="output">
            <div class="mb-5">
                <label for="pyodide-console" class="form-label"><h4>Console</h4></label>
                <textarea class="form-control" id="pyodide-console" rows="3"></textarea>
            </div>
            <div class="mb-5">
                <label for="output-aln" class="form-label"><h4>Output Alignment (first 10,000 characters)</h4></label>
                <textarea class="form-control" id="output-aln" rows="3"></textarea>
            </div>
            <div class="mb-5">
                <label for="seq-aln-map" class="form-label"><h4>Sequence Alignment Map (first 10,000 characters)</h4></label>
                <textarea class="form-control" id="seq-aln-map" rows="3"></textarea>
            </div>
        </div>
    </div>
</body>
</html>