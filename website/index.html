<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="./assets/index.css">
    <script src="https://biowasm.com/cdn/v3/aioli.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>
</head>
<body>
    <script type="module" async>

        // constants & global variables
        const PATH_TO_PYODIDE_ROOT = "/home/pyodide/";

        // load minimap2 from BioWASM
        const CLI = await new Aioli(["minimap2/2.22"]);

        // load pyodide
        const pyodide = await loadPyodide({
            stdout: (text) => {
                document.getElementById("pyodide-console").innerHTML += "STDOUT: " + text + "\n";
            },
            stderr: (text) => {
                document.getElementById("pyodide-console").innerHTML += "STDERR: " + text + "\n";
            },
        });
            
        // load micropip, a package manager for Pyodide
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");
        
        // install biopython, a ViralMSA dependency
        await micropip.install('biopython');

        // create cache directory
        pyodide.FS.mkdir(PATH_TO_PYODIDE_ROOT + 'cache');

        // done loading
        document.getElementById("content").classList.remove("d-none")
        document.getElementById("loading").classList.add("d-none")

        const runViralMSA = async () => {
            const inputSequences = document.getElementById("input-sequences").files[0];
            if (!inputSequences) {
                alert("Please enter an input sequence file.");
                return;
            }

            const referenceSequence = document.getElementById("ref-sequence").files[0];
            if (!referenceSequence) {
                alert("Please enter a reference sequence file.");
                return;
            }
            
            // write provided file to Pyodide
            const inputSeqReader = new FileReader();
            inputSeqReader.readAsText(inputSequences, "UTF-8");
            inputSeqReader.onload = (e) => {
                pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'sequence.fas', e.target.result, { encoding: "utf8" });
            }

            // load in reference file for ViralMSA
            const refSeqReader = new FileReader();
            refSeqReader.readAsText(referenceSequence, "UTF-8");
            refSeqReader.onload = (e) => {
                pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'reference.fas', e.target.result, { encoding: "utf8" });
            }
            
            // load in ViralMSA.py
            pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'ViralMSA.py', await (await fetch("./assets/python/ViralMSA.py")).text(), { encoding: "utf8" });
    
            // set global args variable
            let args = "./ViralMSA.py -e email@address.com -s sequence.fas -o output -r reference.fas --viralmsa_dir cache";
            pyodide.globals.set("arguments", args);
            
            // set global minimapOverride variable to use BioWASM
            const minimap2Override = async (PyProxy) => {
                const command = PyProxy.toJs();
                
                // build minimap2 index
                if (command.includes('-d')) {
                    // remember mmi output path and change to target.mmi for minimap2 in BioWASM
                    const mmiOutput = command[command.length - 2];
                    command[command.length - 2] =  "target.fas.mmi";
                    
                    // mount fasta file to BioWASM
                    const fastaFile = command[command.length - 1];
                    await CLI.mount([{
                        name: "target.fas",
                        data: pyodide.FS.readFile(PATH_TO_PYODIDE_ROOT + fastaFile, { encoding: "utf8" }),
                    }]);
                    
                    // change fasta file name to target.fas for minimap2 in BioWASM
                    command[command.length - 1] = "target.fas";
    
                    // run minimap2 in BioWASM
                    const output = await CLI.exec(command.join(' '));
                    
                    // copy over mmi file to Pyodide
                    const mmi = await CLI.fs.readFile("target.fas.mmi", { encoding: "binary" });
                    pyodide.FS.writeFile(mmiOutput, mmi, { encoding: "binary" })
    
                // alignment
                } else if (command.includes('-a')) {
                    // swap out third to last argument (output file)
                    const oldOutput = command[command.length - 3];
                    command[command.length - 3] = "sequence.fas.sam";
    
                    // swap out second to last argument - use reference.fas instead of reference.fas.mmi and remove pyodide path
                    command[command.length - 2] = "target.fas.mmi";
    
                    // mount sequence.fas
                    CLI.mount([{
                        name: "sequence.fas",
                        data: pyodide.FS.readFile(PATH_TO_PYODIDE_ROOT + "sequence.fas", { encoding: "utf8" }),
                    }]);
    
                    // swap out last argument - use sequence instead of pyodide path
                    command[command.length - 1] = "sequence.fas";
    
                    // run minimap2 in BioWASM
                    const output = await CLI.exec(command.join(' '));
    
                    // copy over sam file to Pyodide
                    const sam = await CLI.download("sequence.fas.sam");
                    const samText = await (await fetch(sam).then(r => r.text()));
                    pyodide.FS.writeFile(oldOutput, samText, { encoding: "utf8" });
                }
            }
            pyodide.globals.set("minimap2Override", minimap2Override);
    
            // callback for when ViralMSA.py finishes
            const ViralMSAFinish = () => {
                const outputPreview = pyodide.FS.readFile(PATH_TO_PYODIDE_ROOT + "output/sequence.fas.aln", { encoding: "utf8" }).substring(0, 100000)
                document.getElementById("output-aln").innerText = outputPreview;
            }
            pyodide.globals.set("ViralMSAFinish", ViralMSAFinish);
    
            // pyodide.globals.set("entrezEfetchOverrideJSFetch", (db, rettype, id) => {
            //     let done = false;
            //     fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=${db}&rettype=${rettype}&id=${id}`)
            //     .then(response => response.text())
            //     .then(fastaText => {
            //         done = true;
            //         pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'cache/' + id + '/' + id + '.fas', fastaText, { encoding: "utf8" });
            //     })
            // })
    
            // run ViralMSAWeb.py
            pyodide.runPython(await (await fetch("./assets/python/ViralMSAWeb.py")).text());
        }

        document.getElementById("runViralMSA").addEventListener("click", runViralMSA);
    </script>
    <h1 class="my-5 text-center">ViralMSA Online Tool</h1>
    <div id="loading">
        <h4 class="text-center" >Loading ... </h4>
    </div>
    <div id="content" class="d-none">
        <div class="input">
            <div class="mb-3">
                <label for="input-sequences" class="form-label">Input Sequences (FASTA Format)</label>
                <input class="form-control" type="file" id="input-sequences">
            </div>
        
            <div class="mb-3">
                <label for="ref-sequence" class="form-label">Reference Sequence</label>
                <input class="form-control" type="file" id="ref-sequence">
            </div>

            <button type="button" class="mt-3 btn btn-primary" id="runViralMSA">Run ViralMSA</button>
        </div>
        <div class="output">
            <div class="mb-3">
                <label for="pyodide-console" class="form-label"><h4>Console</h4></label>
                <textarea class="form-control" id="pyodide-console" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label for="output-aln" class="form-label"><h4>Output Alignment</h4></label>
                <textarea class="form-control" id="output-aln" rows="3"></textarea>
            </div>
        </div>
    </div>
</body>
</html>