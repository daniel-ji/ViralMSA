<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="assets/index.css">
</head>
<body>
    <h1 class="my-5 text-center">ViralMSA Online Tool</h1>
    <script>
        // constants
        const PATH_TO_PYODIDE_ROOT = "/home/pyodide/";

        let pyodide; 
        const initPyodide = async () => {
            // load pyodide
            pyodide = await loadPyodide();
            
            // load micropip, a package manager for Pyodide
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            
            // install biopython, a ViralMSA dependency
            await micropip.install('biopython');

            // create cache directory
            pyodide.FS.mkdir(PATH_TO_PYODIDE_ROOT + 'cache');

            // write example file to Pyodide
            pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'example_hiv.fas', await (await fetch("./assets/example/example_hiv.fas")).text(), { encoding: "utf8" });

            // load in ViralMSA.py
            pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'ViralMSA.py', await (await fetch("./assets/python/ViralMSA.py")).text(), { encoding: "utf8" });

            // set global args variable
            let arguments = "./ViralMSA.py -e email@address.com -s example_hiv.fas -o output -r HIV-1 --viralmsa_dir cache";
            pyodide.globals.set("arguments", arguments); 

            // pyodide.globals.set("entrezEfetchOverrideJSFetch", (db, rettype, id) => {
            //     let done = false;
            //     fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=${db}&rettype=${rettype}&id=${id}`)
            //     .then(response => response.text())
            //     .then(fastaText => {
            //         done = true;
            //         pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'cache/' + id + '/' + id + '.fas', fastaText, { encoding: "utf8" });
            //     })
            // })

            // run ViralMSAWeb.py
            pyodide.runPython(await (await fetch("./assets/python/ViralMSAWeb.py")).text())
        }
        initPyodide();
    </script>
</body>
</html>